#!/usr/bin/env node

const net = require("net");
const { handle_message, send_message, red, green, open_or_closed } = require("./lib/helpers");
const SOCKET = "./bank.sock";


let connTellers = [];
let connCustomers = [];
let beingServed = [];


// TCP Server using a Unix socket

const server = net.createServer((conn) => {
  console.log("client connected");


  handle_message(conn, (message) => {
    // customer connected?

    if (message === "customer") {
      connCustomers.push(conn);


      // !Tellers connected

      if (!connTellers.length) {
        send_message(conn, `The Bank is ${red("closed")}.`);
      }
    }


    // Tellers connected

    else if (message === "teller") {
      connTellers.push(conn);
      send_message(conn, `# customers:${connCustomers.length}`);


      connCustomers.map((conn, i) => {

				open_or_closed(conn, i);
      });
    } else if (message.includes("next")) {
			connCustomers.map((conn, i) => {
				if(i === 0) {
					beingServed.push(conn)
					console.log(connCustomers.length)
					connCustomers.shift()
					console.log(beingServed.length, connCustomers.length)
					send_message(conn, `The Bank is ${green("open")}.\n Teller #1 is now serving you!\n\n [ TELLER ] What can I help you with?\n`
					)
				} else if (i >= 1) {
					open_or_closed(conn, i - 1)

				}
			})
		} 


  });


  conn.on("close", () => {
    console.log("client disconnected");
  });
});


server.listen(SOCKET);
console.log(`Bank server is listening...`);


process.on("exit", shutdown);
process.on("SIGINT", shutdown);
process.on("SIGTERM", shutdown);


process.on("uncaughtException", function (err) {
  console.log("Uncaught ERROR:", err);
});


function shutdown() {
  server.close();
  process.exit();
}
