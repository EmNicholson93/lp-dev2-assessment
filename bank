#!/usr/bin/env node

const net = require("net");
const { handle_message, send_message, red, green, open_or_closed, next_customer } = require("./lib/helpers");
const SOCKET = "./bank.sock";


let connTellers = [];
let connCustomers = [];
let beingServed = [];


// TCP Server using a Unix socket

const server = net.createServer((conn) => {
  console.log("client connected");


  handle_message(conn, (message) => {
		
    // customer connected?
    if (message === "customer") {
      connCustomers.push(conn);

      // !Tellers connected
      if (!connTellers.length) {
        send_message(conn, `The Bank is ${red("closed")}.`);
      }
    }

    // Tellers connected
    else if (message === "teller") {
      connTellers.push(conn);
      send_message(conn, `# customers:${connCustomers.length}`);
			open_or_closed(connCustomers);

    } 
		
		// teller requests next customer
		else if (message.includes("next")) {
			next_customer(connCustomers, beingServed)
		} 


  });


  conn.on("close", () => {
    console.log("client disconnected");
  });
});


server.listen(SOCKET);
console.log(`Bank server is listening...`);


process.on("exit", shutdown);
process.on("SIGINT", shutdown);
process.on("SIGTERM", shutdown);


process.on("uncaughtException", function (err) {
  console.log("Uncaught ERROR:", err);
});


function shutdown() {
  server.close();
  process.exit();
}
